#!/bin/bash

set -exuo pipefail

URL="${1}"
UA='Mozilla/5.0 (Windows NT 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0'

has_cloudflare() {
	local url="${1}"
	dig SOA +multiline "${url}" | grep cloudflare
	return $?
}

download_and_show() {
	local url="${1}"
	local cmd="${2:-torsocks wget}"
	local errormsg='<span font=\"20px\">feh failed</span>'
	local tmpfile
	tmpfile="$(mktemp --dry-run)"
	nohup 2>&1 bash <<<"
    if ! ${cmd} -q -T 60 -O ${tmpfile} -U \"${UA}\" \"${url}\"; then
       notify-send -t 4000 'Error' \"${errormsg}\"
    fi
    feh --title=\"${url}\" ${tmpfile} </dev/null
    rm -f ${tmpfile}" &
}

mpv_site() {
	local url="${1}"
	shift
	local OPTS=("${@}")
	nohup 2>&1 mpv --ytdl-raw-options=all-subs= \
		--sid=1 \
		--no-terminal \
		--user-agent="${UA}" \
		--af=@rb:rubberband \
		--loop \
		--volume=50 \
		--osd-level=3 \
		"${OPTS[@]}" "${url}" &
}

case "${URL,,}" in
*.wav* | *.mp3* | *.m4a*)
	mpv_site "${URL}" --player-operation-mode=pseudo-gui
	;;
*.mov* | *.webm* | *.mp4* | *tiktok.com* | *v.redd.it* | *streamable.com* | *streamja.com*)
	mpv_site "${URL}"
	;;
*imgflip*) # Does not accept TOR
	download_and_show "${URL}" "wget" ;;
*imgur.com/*)
	if [[ ${URL} != *album* && ${URL} != *jpg && ${URL} != *jpeg && ${URL} != *png ]]; then
		download_and_show "${URL}.jpg"
	fi
	;&
*.jpg* | *.png* | *.jpeg* | *.webp*)
	download_and_show "${URL}"
	;;
*.gif)
	nohup 2>&1 mpv --no-terminal --loop --osd-level=3 "${URL}" &
	;;
*.pdf)
	nohup 2>&1 evince "${URL}" &
	;;
*http*://gyazo.com*) # catch things without an extension and add one
	download_and_show "${URL}.jpg" ;;
*news.ycombinator.com*)
	HTTP_PROXY="socks5://127.0.0.1:9050" \
		hackerview -l 100 -t 15s "${URL}" 2>&1 | /usr/share/vim/vim82/macros/less.sh -c 'ColorHighlight' -
	;;
*twitter.com*)
	HTTP_PROXY="socks5://127.0.0.1:9050" \
		twitterview -t 10s -A "${UA}" "${URL}" 2>&1 | /usr/share/vim/vim82/macros/less.sh -c 'ColorHighlight' -
	;;
*lainchan.org*)
	HTTP_PROXY="socks5://127.0.0.1:9050" \
		lainviewer -t 25 -u "${URL}" -A=false 2>&1 | /usr/share/vim/vim82/macros/less.sh -c 'ColorHighlight' -
	;;
*wired-7.org*)
	lainviewer -t 25 -u "${URL}" -A=false | /usr/share/vim/vim82/macros/less.sh -c 'ColorHighlight' -
	;;
*reddit.com/r/*)
	HTTP_PROXY="socks5://127.0.0.1:9050" \
		redditviewer -t 20 -u "${URL}" | /usr/share/vim/vim82/macros/less.sh -c 'ColorHighlight' -
	;;
*linkedin.com*)
	rdrview -B w3m "${URL}"
	;;
*github.com*)
	torsocks rdrview -B w3m "${URL}"
	;;
*youtube.com* | *youtu.be*)
	mpv_site "${URL}" --ytdl-format='bestvideo[height<481]+bestaudio'
	;;
*twitch.tv*)
	nohup streamlink \
		--player mpv \
		--player-args '--no-terminal --af=@rb:rubberband --volume=50 --osd-level=3' \
		"${URL}" \
		"480p,720p,1080p,worst" &
	;;
*)
	domain=${URL#*://}
	domain=${domain%%/*}
	if has_cloudflare "${domain}"; then
		w3m -o "user_agent=${UA}" "${URL}"
	else
		torsocks w3m -o "user_agent=${UA}" "${URL}"
	fi
	;;
esac
